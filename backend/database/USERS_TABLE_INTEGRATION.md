# Users Table & Privy Integration

This document explains the integration between Supabase users table and Privy authentication.

## ğŸ“‹ Overview

The `users` table has been updated to work seamlessly with Privy authentication. All unnecessary columns have been removed, and the table now focuses on essential user data linked to Privy accounts.

## ğŸ—ï¸ Database Schema

### Updated `users` Table Structure

```sql
users (
  id UUID PRIMARY KEY,                    -- Auto-generated by Supabase
  created_at TIMESTAMP,                   -- Auto-generated timestamp
  privy_user_id TEXT UNIQUE NOT NULL,     -- âœ… Privy user ID (unique)
  wallet_address TEXT NOT NULL,           -- âœ… User's wallet address from Privy
  user_type TEXT NOT NULL,                -- âœ… "merchant" or "client"
  email TEXT,                             -- âœ… Email from Privy login
  name TEXT                               -- âœ… Name from Google/other providers
)
```

### Removed Columns (Unnecessary)
- âŒ `country` - Not needed
- âŒ `code` - Not needed
- âŒ `surname` - Use `name` instead
- âŒ `address` - Use `wallet_address` instead

## ğŸ”„ Migration Steps

### 1. Run SQL Migration in Supabase

Go to Supabase Dashboard â†’ SQL Editor and run:

```sql
-- See: backend/database/migrations/001_update_users_table.sql
```

Or use the Supabase CLI:

```bash
supabase migration new update_users_table
# Copy contents from 001_update_users_table.sql
supabase db push
```

## ğŸ”Œ API Endpoints

### POST `/auth/login-or-register`

Register or login a user after Privy authentication.

**Request:**
```json
{
  "privy_user_id": "did:privy:...",
  "wallet_address": "0x...",
  "user_type": "merchant",
  "email": "user@example.com",
  "name": "John Doe"
}
```

**Response:**
```json
{
  "id": "uuid",
  "privy_user_id": "did:privy:...",
  "wallet_address": "0x...",
  "user_type": "merchant",
  "email": "user@example.com",
  "name": "John Doe",
  "created_at": "2025-11-23T..."
}
```

### GET `/auth/user/{privy_user_id}`

Get user by Privy user ID.

**Response:** Same as above

## ğŸ¯ Frontend Integration

### Home Page (`app/page.tsx`)

Automatically registers/logs in user after Privy authentication:

```typescript
import { usePrivy } from '@privy-io/react-auth';
import { loginOrRegisterUser } from './lib/auth';

// In component:
const { authenticated, user } = usePrivy();

useEffect(() => {
  if (authenticated && user) {
    loginOrRegisterUser({
      privy_user_id: user.id,
      wallet_address: user.wallet?.address,
      user_type: 'merchant',
      email: user.email?.address || user.google?.email,
      name: user.google?.name,
    });
  }
}, [authenticated, user]);
```

### Deploy Page (`app/deploy/page.tsx`)

Sends user info when deploying an agent:

```typescript
// User wallet and ID are automatically included in agent deployment
formData.append("user_wallet_address", user.wallet.address);
formData.append("user_id", user.id);
```

## ğŸ”— Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User logs in   â”‚
â”‚   with Privy    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend extracts:     â”‚
â”‚  - privy_user_id        â”‚
â”‚  - wallet_address       â”‚
â”‚  - email (optional)     â”‚
â”‚  - name (optional)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /auth/login-or-   â”‚
â”‚  register               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend checks if      â”‚
â”‚  user exists by         â”‚
â”‚  privy_user_id          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Create â”‚ â”‚  Update  â”‚
â”‚  New  â”‚ â”‚ Existing â”‚
â”‚ User  â”‚ â”‚   User   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Return user record     â”‚
â”‚  to frontend            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Backend Implementation

### New Files Created

1. **`backend/database/supabase/operations/users.py`**
   - `UsersOperations` class
   - `create_or_update_user()` - Main method to handle user registration
   - `get_user_by_privy_id()` - Get user by Privy ID
   - `get_user_by_wallet()` - Get user by wallet address

2. **`backend/routes/auth/routes.py`**
   - `POST /auth/login-or-register` - User registration endpoint
   - `GET /auth/user/{privy_user_id}` - Get user endpoint

3. **`backend/routes/auth/models.py`**
   - `UserLoginRequest` - Request model
   - `UserResponse` - Response model

### Updated Files

1. **`backend/main.py`**
   - Added auth router

2. **`backend/routes/agent/routes.py`**
   - Added `user_wallet_address` and `user_id` parameters
   - Agent owner is now set to user's wallet address or Privy ID

## ğŸ¨ Frontend Implementation

### New Files Created

1. **`frontend/app/lib/auth.ts`**
   - `loginOrRegisterUser()` - Register/login user
   - `getUserByPrivyId()` - Get user by Privy ID
   - Type definitions for User and UserLoginData

### Updated Files

1. **`frontend/app/page.tsx`**
   - Auto-registers user after Privy authentication
   - Extracts email and name from Privy user object

2. **`frontend/app/deploy/page.tsx`**
   - Already sends user wallet and ID to backend (no changes needed)

## âœ… Benefits

1. **No Manual User Creation**: Users are automatically created when they log in with Privy
2. **Consistent Data**: All user data comes from Privy authentication
3. **Simple Schema**: Only essential columns, no unnecessary data
4. **Automatic Linking**: Agents are automatically linked to their creator via `owner` field
5. **Email & Name**: Captured from Google/email login when available

## ğŸ” Testing

### 1. Test User Registration

```bash
# Login with Privy on frontend
# User should be automatically created in Supabase

# Check Supabase users table - you should see:
# - privy_user_id populated
# - wallet_address populated
# - user_type = "merchant" (default)
# - email (if logged in with email/Google)
# - name (if logged in with Google)
```

### 2. Test Agent Deployment

```bash
# Deploy an agent after logging in
# Check agents table - owner field should be set to user's wallet address or Privy ID
```

## ğŸ“ Notes

- **Default user_type**: Currently set to "merchant" by default. Can be changed later if needed.
- **Unique constraint**: `privy_user_id` has a unique constraint to prevent duplicate users.
- **Indexes**: Created indexes on `privy_user_id` and `wallet_address` for fast lookups.
- **Backwards compatibility**: Existing users without `privy_user_id` will continue to work.

## ğŸ” Security

- Uses Supabase service role key for database operations (server-side only)
- No sensitive data stored in users table
- Wallet addresses are public information
- Private keys are stored encrypted in agents table, not users table

